name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install google-generativeai

      - name: AI Reviewer (Direct Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.AI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "
          import os
          import google.generativeai as genai
          import subprocess

          def run():
              genai.configure(api_key=os.environ['GEMINI_API_KEY'])
              model = genai.GenerativeModel('gemini-1.5-flash')
              
              # Pega o diff do PR
              diff = subprocess.check_output(['git', 'diff', 'origin/${{ github.base_ref }}...HEAD']).decode('utf-8')
              
              if not diff:
                  print('No changes found.')
                  return

              prompt = f'''Aja como um Engenheiro de SeguranÃ§a SÃªnior (DevSecOps). 
              Analise o DIFF deste Pull Request em PortuguÃªs buscando:
              1. Vulnerabilidades OWASP Top 10 (especialmente SQL Injection e Insecure Deserialization).
              2. Code Smells e melhorias de cÃ³digo.
              3. Melhores prÃ¡ticas de Java 25 e Spring Boot.

              DIFF:
              {diff}
              
              Responda de forma concisa em PortuguÃªs.
              '''
              
              response = model.generate_content(prompt)
              review_text = response.text
              
              # Salva o comentÃ¡rio em um arquivo para o gh CLI
              with open('review.md', 'w') as f:
                  f.write('### ðŸ¤– IA Code Review (Gemini)\n\n' + review_text)
              
              # Posta o comentÃ¡rio no PR
              subprocess.run(['gh', 'pr', 'comment', str(${{ github.event.pull_request.number }}), '--body-file', 'review.md'], check=True)

          run()
          "
