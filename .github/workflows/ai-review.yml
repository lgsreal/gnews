name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install openai

      - name: AI Reviewer (OpenAI-Compatible Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.AI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "
          import os
          from openai import OpenAI
          import subprocess
          import sys

          def run():
              try:
                  # Configura cliente OpenAI apontando para o Google Gemini
                  client = OpenAI(
                      api_key=os.environ['GEMINI_API_KEY'],
                      base_url='https://generativelanguage.googleapis.com/v1beta/openai/'
                  )
                  
                  # Pega o diff do PR
                  diff = subprocess.check_output(['git', 'diff', 'origin/${{ github.base_ref }}...HEAD']).decode('utf-8')
                  
                  if not diff:
                      print('No changes found.')
                      return

                  prompt = f'''Aja como um Engenheiro de SeguranÃ§a SÃªnior (DevSecOps). 
                  Analise o DIFF deste Pull Request em PortuguÃªs buscando:
                  1. Vulnerabilidades OWASP Top 10 (especialmente SQL Injection e Insecure Deserialization).
                  2. Code Smells e melhorias de cÃ³digo.
                  3. Melhores prÃ¡ticas de Java 25 e Spring Boot.

                  DIFF:
                  {diff}
                  
                  Responda de forma concisa em PortuguÃªs diretamente no comentÃ¡rio do PR.
                  '''
                  
                  response = client.chat.completions.create(
                      model='gemini-1.5-flash',
                      messages=[
                          {'role': 'system', 'content': 'VocÃª Ã© um revisor de cÃ³digo experiente.'},
                          {'role': 'user', 'content': prompt}
                      ]
                  )
                  
                  review_text = response.choices[0].message.content
                  
                  with open('review.md', 'w') as f:
                      f.write('### ðŸ¤– IA Code Review (Gemini)\n\n' + review_text)
                  
                  # Posta o comentÃ¡rio no PR
                  subprocess.run(['gh', 'pr', 'comment', str(${{ github.event.pull_request.number }}), '--body-file', 'review.md'], check=True)
                  print('Review posted successfully.')
              except Exception as e:
                  print(f'Error during AI review: {e}')
                  sys.exit(1)

          run()
          "
