name: Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install requests google-generativeai -q

      - name: Get PR Diff
        id: diff
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          git diff origin/main...pr-branch > /tmp/diff.patch || git diff HEAD > /tmp/diff.patch
          echo "completed=true" >> $GITHUB_OUTPUT

      - name: Gemini Code Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'REVIEW_SCRIPT'
          import os
          import json
          import requests
          
          api_key = os.getenv('GEMINI_API_KEY')
          if not api_key:
              print("::warning::GEMINI_API_KEY not configured")
              exit(0)
          
          # Read diff
          with open('/tmp/diff.patch', 'r') as f:
              diff_content = f.read()[:15000]  # Limit to 15KB
          
          if not diff_content.strip():
              print("No changes to review")
              with open('/tmp/review.txt', 'w') as f:
                  f.write("âœ… No changes detected in this PR.")
              exit(0)
          
          prompt = f"""VocÃª Ã© um Engenheiro de SeguranÃ§a SÃªnior (DevSecOps) especializado em Java e Spring Boot.

Analise este DIFF de Pull Request e identifique:

1. **VULNERABILIDADES CRÃTICAS** (SQL Injection, RCE, Deserialization, etc.)
2. **PROBLEMAS DE SEGURANÃ‡A** (Hardcoded secrets, XSS, CORS inseguro, etc.)
3. **CODE SMELLS** (God methods, dead code, duplicaÃ§Ã£o, etc.)
4. **MELHORES PRÃTICAS** (Java 21+, Spring Boot 3.4)

Responda em **PortuguÃªs** com severidade (ðŸ”´ CRÃTICO / ðŸŸ  ALTO / ðŸŸ¡ MÃ‰DIO / ðŸŸ¢ BAIXO).

DIFF:
```diff
{diff_content}
```

ForneÃ§a:
- Resumo executivo
- Lista de issues por severidade
- CÃ³digo corrigido para problemas crÃ­ticos"""
          
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}"
          
          headers = {'Content-Type': 'application/json'}
          payload = {
              'contents': [{
                  'parts': [{
                      'text': prompt
                  }]
              }],
              'generationConfig': {
                  'maxOutputTokens': 2000
              }
          }
          
          response = requests.post(url, json=payload, headers=headers, timeout=30)
          
          if response.status_code == 200:
              data = response.json()
              if 'candidates' in data and data['candidates']:
                  review = data['candidates'][0]['content']['parts'][0]['text']
                  with open('/tmp/review.txt', 'w') as f:
                      f.write(review)
                  print("âœ… Review generated successfully")
              else:
                  with open('/tmp/review.txt', 'w') as f:
                      f.write("âš ï¸ No review generated - empty response")
          else:
              print(f"::error::API Error {response.status_code}: {response.text}")
              with open('/tmp/review.txt', 'w') as f:
                  f.write(f"âŒ Error generating review: {response.status_code}")
          REVIEW_SCRIPT

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ðŸ¤– AI Code Review (Gemini 2.0 Flash)\n\n';
            
            try {
              const review = fs.readFileSync('/tmp/review.txt', 'utf8');
              comment += review;
            } catch (err) {
              comment += 'âš ï¸ Failed to generate review. Please check if GEMINI_API_KEY secret is configured.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
