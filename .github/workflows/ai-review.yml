name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AI Reviewer
        uses: anc95/ChatGPT-CodeReview@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

          # --- CORREÇÃO DO ERRO 404 ---
          # Adicionei a barra '/' no final. NÃO REMOVA.
          OPENAI_API_ENDPOINT: https://generativelanguage.googleapis.com/v1beta/openai/

          LANGUAGE: Portuguese

          # Modelo robusto contra o erro 429
          MODEL: gemini-1.5-flash

          # Tokens controlados para evitar timeout
          MAX_TOKENS: 2500

          # --- FILTRO CRÍTICO (ERRO 429) ---
          # Mantive seus filtros. Eles são essenciais.
          ignore_patterns: package-lock.json,yarn.lock,pnpm-lock.yaml,*.lock,*.png,*.jpg,*.svg,*.json,dist/**,*.xml,*.gradle,*.md

          PROMPT: |
            Aja como um Engenheiro de Segurança Sênior (DevSecOps).
            Analise o DIFF buscando:
            1. Vulnerabilidades OWASP Top 10.
            2. Code Smells graves.
            3. Aderência a Java 21+ e Spring Boot 3.x.
            Seja conciso.